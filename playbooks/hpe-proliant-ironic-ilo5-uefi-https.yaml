- hosts: all
  name: HPE Proliant ilo5 uefi https job
  tasks:
    - block:
        - name: Generate MoltenIron Id for node
          command: uuidgen
          register: uuid

        - name: Clone gate jobs
          shell: cd /home/citest; git clone https://github.com/hpproliant/NEW-HPE-CI-JOBS.git
        
        - name: Kolla bootstrapping and Kolla deploy
          shell: /home/citest/NEW-HPE-CI-JOBS/kolla-deploy.sh

        - name: Allocating test node
          command: /home/citest/NEW-HPE-CI-JOBS/molteniron/allocate_molten.py {{ uuid.stdout }} Gen10 strict

        - name: Running ilo5-uefi-https gate
          shell: /home/citest/NEW-HPE-CI-JOBS/ilo5-uefi-https/gate.sh {{zuul.ref}} 2>&1 | tee /home/citest/gate_logs/gate.logs

        - name: Deallocating test node
          shell: /home/citest/NEW-HPE-CI-JOBS/molteniron/release_molten.py {{ uuid.stdout }}

        - name: Remove cert
          shell: /home/citest/NEW-HPE-CI-JOBS/ilo5-uefi-https/files/remove_cert
      rescue:
        - name: Deallocating test node
          shell: /home/citest/NEW-HPE-CI-JOBS/molteniron/release_molten.py {{ uuid.stdout }}
        
        - name: Remove cert
          shell: /home/citest/NEW-HPE-CI-JOBS/ilo5-uefi-https/files/remove_cert

        - name: Job failed
          fail:
            msg: "HPE ilo5-uefi-https job failed."
      always:
        - name: Deallocating test node
          shell: /home/citest/NEW-HPE-CI-JOBS/molteniron/release_molten.py {{ uuid.stdout }}

        - name: Check job status
          stat:
            path: "/tmp/job-failed"
          register: result

        - name: Check job failed
          fail:
            msg: "HPE ilo5-uefi-https job failed."
          when: result.stat.exists
